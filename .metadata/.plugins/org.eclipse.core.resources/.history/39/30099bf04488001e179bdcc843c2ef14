<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<jsp:include page="../layout/header.jsp">
  <jsp:param value="자유게시판" name="title"/>
</jsp:include>

<style>
  .blind {
    display: none;
  }
</style>
<body>
  <div th:replace="~{/layout/header::header}"></div>
  <div class="main_wrap">
  <div class="wrap wrap_9">
      <a th:href="@{/free/write.form}">
        <button type="button" class="btn btn-primary">새글작성</button>
        </a>
      
      <hr>
      
      <div>
        <table border="1">
          <thead>
            <tr>
              <td>순번</td>
              <td>작성자</td>
              <td>내용</td>
              <td>작성일자</td>
            </tr>
          </thead>
          <tbody>
            <c:forEach items="${freeList}" var="free" varStatus="vs">
              <tr class="list">
                <td>${beginNo - vs.index}</td>
                <!-- 정상 게시글 -->            
                <th:block th:if="${free.status == 1}">
                  <th:block th:if="${free.email != null}">
                    <td th:text="${free.email}"></td>
                  </th:block>
                  <td>
                    <!-- depth에 따른 들여쓰기 -->              
                    <c:forEach begin="1" end="${free.depth}" step="1">&nbsp;&nbsp;</c:forEach>
                    <span th:each="n:${#numbers.sequence(1,free.depth, 1)}" th:utext="|&nbsp;&nbsp;|"></span>
                    <!-- 댓글은 댓글 아이콘 부착하기 -->
                    <th:block th:if="${free.depth != 0}">
                      <i class="fa-brands fa-replyd"></i>
                    </th:block>
                    <!-- 게시글내용 -->
                    <span th:text="${free.contents}"></span>
                    <!-- 댓글작성버튼 -->
                    <button type="button" class="btn_reply">댓글</button>
                    <!-- 게시글삭제버튼 -->
                    <form class="frm_remove" method="post" action="@{/free/remove.do}" style="display: inline;">
                      <th:block th:if"${free.email == sessionScope.user.email}">                  
                        <input type="hidden" name="freeNo" th:value="${free.freeNo}">
                        <button type="submit">삭제</button>
                      </th:block>
                    </form>
                  </td>
                  <td th:text="${#dates.format(free.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                  </th:block>
                 <!-- 삭제된 게시글 -->
                 <th:block th:if="${free.status == 0}">
                   <td colspan="3">
                    삭제된 게시글입니다.
                   </td>
                 </th:block>
                </td>
              </tr>
              <tr class="blind write_tr">
                <td colspan="4">
                  <form method="post" action="@{/free/addReply.do}">
                    <div>
                      <label for="email">작성자</label>
                      <input type="text" name="email" id="email" th:value="${sessionScope.user.email}" readonly>
                    </div>
                    <div>
                      <label for="contents">내용</label>
                      <input type="text" name="contents" id="contents">
                    </div>
                    <div>
                      <input type="hidden" name="depth" th:value="${free.depth}">
                      <input type="hidden" name="groupNo" th:value="${free.groupNo}">
                      <input type="hidden" name="groupOrder" th:value="${free.groupOrder}">
                      <button type="submit">댓글달기</button>
                    </div>
                  </form>
                </td>
              </tr>
            </c:forEach>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" th:utext="${paging}"></td>
            </tr>
          </tfoot>
        </table>
        <div>
          <form method="get" action="@{/free/search.do}">
            <select name="column">
              <option value="EMAIL">작성자</option>
              <option value="CONTENTS">내용</option>
            </select>
            <input type="text" name="query" placeholder="검색어 입력">
            <button type="submit" class="btn btn-outline-primary">검색</button>
          </form>
        </div>
      </div>

  </div>

<script>

  const fnAddResult = () => {
	  let addResult = /*[[${addResult}]]*/ null;
	  if(addResult !== null ){
		  if(addResult === 1){
			  alert('게시글이 등록되었습니다.');
		  } else {
			  alert('게시글이 등록되지 않았습니다.');
		  }
	  }
  }
  
  const fnBlind = () => {
	  $('.btn_reply').click((ev) => {
		  if('${sessionScope.user}' === ''){
			  if(confirm('로그인이 필요한 기능입니다. 로그인할까요?')){
				  location.href = '@{/user/login.form}';
			  } else {
				  return;
			  }
		  }
		  // 화살표 함수는 this 객체가 지원되지 않기 때문에
		  // 이벤트 대상을 "이벤트 객체"의 "target" 속성으로 처리한다.
		  let writeTr = $(ev.target).closest('.list').next();
		  // class="blind"를 가진 상태 : 숨김 상태이므로 열어 준다.
		  if(writeTr.hasClass('blind')){
			  $('.write_tr').addClass('blind');  // 모든 작성화면 닫기
			  writeTr.removeClass('blind');      // 현재 작성화면 열기
		  }
		  // class="blind"가 없는 상태 : 이미 열린 상태이므로 다시 숨긴다.
		  else {
			  writeTr.addClass('blind');
		  }
	  })
  }
  
  const fnAddReplyResult = () => {
    let addReplyResult = '${addReplyResult}';
    if(addReplyResult !== ''){
      if(addReplyResult === '1'){
        alert('댓글이 등록되었습니다.');
      } else {
        alert('댓글이 등록되지 않았습니다.');
      }
    }
  }

  const fnRemove = () => {
	  $('.frm_remove').submit((ev) => {
		  if(!confirm('게시글을 삭제할까요?')){
			  ev.preventDefault();
			  return;
		  }
	  })
  }
  
  const fnRemoveResult = () => {
    let removeResult = '${removeResult}';
    if(removeResult !== ''){
      if(removeResult === 1){
        alert('게시글이 삭제되었습니다.');
      } else {
        alert('게시글이 삭제되지 않았습니다.');
      }
    }
  }
  
  fnAddResult();
  fnBlind();
  fnAddReplyResult();
  fnRemove();
  fnRemoveResult();

</script>
</div>
    <div th:replace="~{/layout/footer::footer}"></div>
</body>
</html>